name: 'uv-install-package'
description: |
  Install Python packages with uv, auto-resolving compatible versions for your target
  Python environment via PyPI.

author: "Thibaut Durand"

branding:
  icon: 'box'
  color: 'purple'

inputs:
  package-name:
    description: 'The package name (e.g., numpy, requests, django)'
    required: true
  package-version:
    description: 'The target package version (e.g., "1.2.3", "2.0.0")'
    required: true
  python-version:
    description: 'The Python version to check compatibility against (e.g., "3.10", "3.11", "3.12")'
    required: true
  uv-args:
    description: 'Additional arguments to pass to uv (e.g., "--index-url https://custom.pypi.org/simple")'
    required: false
    default: ''

outputs:
  closest-valid-version:
    description: 'The closest valid package version that matches your constraints and is compatible with the specified Python version'
    value: ${{ steps.find-version.outputs.closest-valid-version }}
  installed-successfully:
    description: 'Boolean indicating whether the package was installed successfully'
    value: ${{ steps.install-package.outcome == 'success' }}

runs:
  using: "composite"
  steps:
    # ============================================================================
    # Step 1: Verify uv package manager is available
    # ============================================================================
    # Check that uv is installed and available on the runner. This action
    # requires uv to be pre-installed (e.g., via astral-sh/setup-uv action).
    # Displays the installation path and version for debugging purposes.
    - name: Verify uv is installed
      shell: bash
      run: |
        set -euo pipefail

        echo "üîç Checking for uv installation..."

        if ! command -v uv &> /dev/null; then
          echo "::error::‚ùå uv is not installed or not in PATH. Please install uv before using this action (e.g., use astral-sh/setup-uv)"
          exit 1
        fi

        # Display uv location and version information
        echo "‚úÖ uv is installed"
        echo "üìç Location: $(which uv)"
        echo "üè∑Ô∏è  Version: $(uv --version)"

    # ============================================================================
    # Step 2: Validate inputs
    # ============================================================================
    # Validate that required inputs are provided and in expected format.
    # This catches common input errors early with helpful error messages.
    - name: Validate inputs
      shell: bash
      run: |
        set -euo pipefail

        echo "üîç Validating action inputs..."

        # Validate package-name is not empty
        PACKAGE_NAME="${{ inputs.package-name }}"
        if [ -z "$PACKAGE_NAME" ]; then
          echo "::error::‚ùå package-name cannot be empty"
          exit 1
        fi

        # Validate package-name doesn't contain obviously invalid characters
        if [[ "$PACKAGE_NAME" =~ [[:space:]] ]]; then
          echo "::error::‚ùå package-name cannot contain whitespace: '$PACKAGE_NAME'"
          exit 1
        fi

        # Validate package-version is not empty
        PACKAGE_VERSION="${{ inputs.package-version }}"
        if [ -z "$PACKAGE_VERSION" ]; then
          echo "::error::‚ùå package-version cannot be empty"
          exit 1
        fi

        # Check for potentially dangerous characters in uv-args (shell metacharacters)
        UV_ARGS="${{ inputs.uv-args }}"
        if [[ "$UV_ARGS" =~ [;\|] ]]; then
          echo "::warning::‚ö†Ô∏è  uv-args contains shell metacharacters (';' or '|'). Ensure these are properly escaped and intentional."
        fi

        echo "‚úÖ Input validation passed"

    # ============================================================================
    # Step 3: Validate and normalize Python version
    # ============================================================================
    # Validates that the Python version is in major.minor format (e.g., "3.10").
    # If a patch version is provided (e.g., "3.10.1"), it will be normalized
    # to just major.minor (e.g., "3.10").
    - name: Validate Python version
      id: validate-python-version
      shell: bash
      run: |
        set -euo pipefail

        PYTHON_VERSION="${{ inputs.python-version }}"
        echo "üîç Validating Python version: $PYTHON_VERSION"

        # Call the validation script
        SCRIPT_PATH="${{ github.action_path }}/scripts/validate_python_version.sh"
        if ! NORMALIZED_VERSION=$("$SCRIPT_PATH" "$PYTHON_VERSION" 2>&1); then
          echo "::error::‚ùå Invalid Python version format: '$PYTHON_VERSION'. Expected format: 'X.Y' or 'X.Y.Z' (e.g., '3.10' or '3.10.1')"
          exit 1
        fi

        echo "‚úÖ Python version validated: $NORMALIZED_VERSION"

        # Show warning if patch version was provided and normalized
        TRIMMED_INPUT=$(echo "$PYTHON_VERSION" | xargs)
        if [ "$TRIMMED_INPUT" != "$NORMALIZED_VERSION" ]; then
          echo "::warning::Python version '$PYTHON_VERSION' normalized to '$NORMALIZED_VERSION' (patch version ignored)"
        fi

        # Export the normalized version for use in subsequent steps
        echo "normalized-python-version=$NORMALIZED_VERSION" >> "$GITHUB_OUTPUT"

    # ============================================================================
    # Step 4: Install feu package for version resolution
    # ============================================================================
    # The 'feu' package provides utilities to find compatible package versions
    # based on Python version constraints. We install it with the [cli] extra
    # to get command-line tools.
    - name: Install dependencies
      shell: bash
      run: |
        # Exit immediately if any command fails
        set -euo pipefail
        echo "üì¶ Installing feu package..."
        
        # Try to install feu with retry logic for transient network issues
        MAX_ATTEMPTS=3
        ATTEMPT=1
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          if uv pip install "feu[cli]>=0.6.2,<0.7.0"; then
            echo "‚úÖ Dependencies installed"
            break
          else
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "::error::‚ùå Failed to install feu package after $MAX_ATTEMPTS attempts. Check network connectivity and ensure uv is configured correctly."
              exit 1
            fi
            echo "::warning::‚ö†Ô∏è  Installation attempt $ATTEMPT failed, retrying..."
            sleep 2
            ATTEMPT=$((ATTEMPT + 1))
          fi
        done

    # ============================================================================
    # Step 5: Find the closest valid package version
    # ============================================================================
    # Query PyPI to find the closest available version that matches:
    # - The requested package version (exact or range)
    # - Compatibility with the specified Python version
    # This prevents installation failures from incompatible versions.
    - name: Find closest valid version
      id: find-version
      shell: bash
      run: |
        set -euo pipefail

        NORMALIZED_PYTHON_VERSION="${{ steps.validate-python-version.outputs.normalized-python-version }}"

        echo "üîé Searching for closest valid version..."
        echo "  üì¶ Package: ${{ inputs.package-name }}"
        echo "  üéØ Target version: ${{ inputs.package-version }}"
        echo "  üêç Python version: $NORMALIZED_PYTHON_VERSION"

        # Run feu to resolve the closest compatible version
        if ! VERSION=$(python -m feu find-closest-version \
          --pkg-name="${{ inputs.package-name }}" \
          --pkg-version="${{ inputs.package-version }}" \
          --python-version="$NORMALIZED_PYTHON_VERSION" 2>&1); then
          echo "::error::‚ùå Failed to query PyPI for package '${{ inputs.package-name }}'."
          echo "::error::Possible causes:"
          echo "::error::  - Package name is incorrect (verify on https://pypi.org/)"
          echo "::error::  - Network connectivity issues"
          echo "::error::  - PyPI is temporarily unavailable"
          echo "::error::  - Custom index (via uv-args) is not accessible"
          exit 1
        fi

        # Validate that we got a version back
        if [ -z "$VERSION" ]; then
          echo "::error::‚ùå No compatible version found for package '${{ inputs.package-name }}' version '${{ inputs.package-version }}' with Python $NORMALIZED_PYTHON_VERSION"
          echo "::error::Suggestions:"
          echo "::error::  - Check if the package supports Python $NORMALIZED_PYTHON_VERSION on PyPI"
          echo "::error::  - Try a different package version"
          echo "::error::  - Try a different Python version"
          exit 1
        fi

        # Validate version format (should be digits.digits.digits or similar)
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+'; then
          echo "::error::‚ùå Invalid version format returned: '$VERSION'"
          exit 1
        fi

        echo "‚úÖ Found closest valid version: $VERSION"
        # Export the version for use in subsequent steps
        echo "closest-valid-version=$VERSION" >> "$GITHUB_OUTPUT"

    # ============================================================================
    # Step 6: Install the resolved package version
    # ============================================================================
    # Use feu's installer wrapper to install the package with uv.
    # This ensures consistent installation behavior and proper handling of
    # any additional uv arguments passed by the user.
    - name: Install package
      id: install-package
      shell: bash
      run: |
        set -euo pipefail

        # Get the version we resolved in the previous step
        CLOSEST_VERSION="${{ steps.find-version.outputs.closest-valid-version }}"

        echo "üì• Installing package..."
        echo "  üì¶ Package: ${{ inputs.package-name }}"
        echo "  üè∑Ô∏è  Version: $CLOSEST_VERSION"

        # Install the package using feu's installer wrapper
        python -m feu install \
          --installer-name=uv \
          --installer-args="${{ inputs.uv-args }}" \
          --pkg-name="${{ inputs.package-name }}" \
          --pkg-version="$CLOSEST_VERSION"

        echo "::notice::‚úÖ Successfully installed ${{ inputs.package-name }}==$CLOSEST_VERSION"

    # ============================================================================
    # Step 7: Verify package installation
    # ============================================================================
    # Verify that the installed package can be imported successfully.
    # This catches issues where installation succeeded but the package is broken.
    - name: Verify installation
      shell: bash
      run: |
        set -euo pipefail

        echo "üîç Verifying package installation..."
        
        # Convert package name to import name (replace hyphens with underscores)
        IMPORT_NAME=$(echo "${{ inputs.package-name }}" | sed 's/-/_/g')
        
        # Try to import the package
        if python -c "import $IMPORT_NAME" 2>/dev/null; then
          echo "‚úÖ Package '${{ inputs.package-name }}' imports successfully"
        else
          # Some packages have different import names than package names
          # Try with the original package name as well
          if python -c "import ${{ inputs.package-name }}" 2>/dev/null; then
            echo "‚úÖ Package '${{ inputs.package-name }}' imports successfully"
          else
            echo "::warning::‚ö†Ô∏è  Package installed but could not verify import. This may be normal for packages without importable modules (e.g., CLI tools)."
          fi
        fi
